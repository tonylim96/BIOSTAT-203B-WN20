---
title: "BIOSTAT 203B Homework 2"
author: Tony Lim
subtitle: Due Friday, 2/7 @ 11:59 PM
output: 
  html_document:
      toc: true
      toc-depth: 4
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
```

```{r}
sessionInfo()
```

-----

Use tidyverse (ggpot2, dplyr) to explore the [MIMIC-III](https://mimic.physionet.org) data introduced in [homework 1](https://ucla-biostat203b-2020winter.github.io/hw/hw1/hw1.html).

-----

## Q1

Demographic information of the patients admitted into hospital is available in `ADMISSION.csv`. See <https://mimic.physionet.org/mimictables/admissions/> for details of each field in this file. Summarize following variables using appropriate graphs:   

- admission year  
- admission month  
- admission week day  
- admission hour  
- length of hospital stay  
- admission type  
- number of admissions per patient  
- admission location  
- insurance  
- language  
- religion  
- martial status  
- ethnicity  
- death 

Note it is possible that one patient (uniquely identified by the `SUBJECT_ID`) is admitted into hospital multiple times. When summarizing some demographic information, it makes sense to summarize based on only unique patients. 

### Prerequisities

Load tidyverse and lubridate:
```{r}
library(tidyverse)
library(lubridate)
```

```{bash}
head /home/203bdata/mimic-iii/ADMISSIONS.csv
```

```{r}
admissions <- read_csv("/home/203bdata/mimic-iii/ADMISSIONS.csv")
admissions %>% print(width = Inf)
```

```{r}
admissions <- read_csv("/home/203bdata/mimic-iii/ADMISSIONS.csv", 
                      col_types = cols(ROW_ID = col_integer(),
                                       SUBJECT_ID = col_integer(),
                                       HADM_ID = col_integer(),
                                       HOSPITAL_EXPIRE_FLAG = col_logical(),
                                       HAS_CHARTEVENTS_DATA = col_logical()))

admissions %>% print(width = Inf)
```

### Admission year

```{r}
admissions %>%
  mutate(adm_year = year(ADMITTIME)) %>%
  ggplot(mapping = aes(x = adm_year)) + 
  geom_bar(fill = "blue") +
  ggtitle("Count of admissions by admission year") +
  xlab("Admission year") +
  ylab("Count")
```

Data for 12 years extended to 100 years. Therefore, average admission per year is about 6000, which is about 16 admissions per day.

### Admission month

```{r}
admissions %>%
  mutate(adm_month = month(ADMITTIME, label = TRUE)) %>%
  ggplot() + 
  geom_bar(mapping = aes(x = adm_month)) +
  ggtitle("Count of admissions by admission month") +
  xlab("Admission month") +
  ylab("Count")
```

### Admission week day

```{r}
admissions %>%
  mutate(adm_weekdays = wday(ADMITTIME, label = TRUE)) %>%
  ggplot() + 
  geom_bar(mapping = aes(x = adm_weekdays)) +
  ggtitle("Count of admissions by admission week day") +
  xlab("Admission day") +
  ylab("Count")
```

### Admission hour

```{r}
admissions %>%
  mutate(adm_hour = hour(ADMITTIME)) %>%
  ggplot() + 
  geom_bar(mapping = aes(x = adm_hour)) +
  ggtitle("Count of admissions by admission hour") +
  xlab("Admission hour") +
  ylab("Count")
```

It appears there is a spike at 7:00 AM. This may be the hospitals' opening time, so patients want to be seen as soon as possible. 

### Admission minute

```{r}
admissions %>%
  mutate(adm_min = minute(ADMITTIME)) %>%
  ggplot() + 
  geom_bar(mapping = aes(x = adm_min)) +
  ggtitle("Count of admissions by admission minute") +
  xlab("Admission minute") +
  ylab("Count") +
  scale_x_continuous(breaks = c(0, 15, 30, 45, 60))
```

It appears there are spikes at 15/30/45 minutes. This may be due to nurses rounding when they manually entering data for `ADMITTIME`.

### Length of hospital stay

```{r}
admissions %>%
  mutate(los_days = as.numeric(as.duration(DISCHTIME - ADMITTIME) / 86400)) %>%
  ggplot() + 
  geom_histogram(mapping = aes(x = los_days)) +
  ggtitle("Length of stay in days") +
  xlab("Length of stay (days)") + 
  ylab("Count")
```

300 days / 10ish = 30 days

### Admission type  

```{R}
admissions %>%
  ggplot() + 
  geom_bar(mapping = aes(x = ADMISSION_TYPE)) +
  ggtitle("Count by admission type") +
  xlab("Admission type") +
  ylab("Count")
```

### Number of admissions per patient

```{r}
admissions %>%
  group_by(SUBJECT_ID) %>%
  dplyr::summarise(n = n()) %>%
  arrange(desc(n))
```


### Admission location

```{R}
admissions %>%
  ggplot() + 
  geom_bar(mapping = aes(x = ADMISSION_LOCATION)) +
  ggtitle("Count by admission type") +
  xlab("Admission type") +
  ylab("Count") +
  coord_flip()
```

### Insurance

```{R}
admissions %>%
  ggplot() + 
  geom_bar(mapping = aes(x = INSURANCE)) +
  ggtitle("Count by insurance type") +
  xlab("Insurance type") +
  ylab("Count")
```

### Language

```{R}
tmp <- admissions %>%
  plyr::count("LANGUAGE")

tmp

tmp %>% arrange(desc(freq))  %>%
  filter(rank(desc(freq)) < 11) %>%
  ggplot() +
  geom_bar(mapping = aes(x = reorder(LANGUAGE, freq), y = freq),
           stat = "identity") +
  ggtitle("Language") +
  xlab("Language") +
  ylab("Count") +
  coord_flip()
```

### Religion

```{R}
admissions %>%
  plyr::count("RELIGION") %>%
  arrange(desc(freq)) %>%
  filter(rank(desc(freq)) < 11) %>%
  ggplot() +
  geom_bar(mapping = aes(x = reorder(RELIGION, freq), y = freq), 
           stat = "identity") +
  ggtitle("Count by religion") +
  xlab("Religion") +
  ylab("Count") +
  coord_flip()
```

### Martial status

```{R}
admissions %>%
  ggplot() + 
  geom_bar(mapping = aes(x = MARITAL_STATUS)) +
  ggtitle("Count by marital status") +
  xlab("Marital status") +
  ylab("Count") +
  coord_flip()
```

### Ethnicity

```{R}
admissions %>%
  plyr::count("ETHNICITY") %>%
  arrange(desc(freq)) %>%
  filter(rank(desc(freq)) < 11) %>%
  ggplot() +
  geom_bar(mapping = aes(x = reorder(ETHNICITY, freq), y = freq), 
           stat = "identity") +
  ggtitle("Count by ethnicity") +
  xlab("Ethnicity") +
  ylab("Count") +
  coord_flip()
```

### Death

```{R}
admissions %>%
  ggplot() + 
  geom_bar(mapping = aes(x = HOSPITAL_EXPIRE_FLAG), width = 0.25) +
  ggtitle("Count by survival status") +
  xlab("Survival status") +
  ylab("Count") +
  scale_x_discrete(labels = c("FALSE" = "Survival to hospital discharge",
                              "TRUE" = "Death in the hospital"))
```

-----

## Q2

Link the data in `ADMISSION.csv` and `PATIENTS.csv` (<https://mimic.physionet.org/mimictables/patients/>) and summarize following variables using appropriate graphs:  

- gender  
- age at admission 

```{bash}
head /home/203bdata/mimic-iii/ADMISSIONS.csv
echo
head /home/203bdata/mimic-iii/PATIENTS.csv
```

```{r}
admissions <- read_csv("/home/203bdata/mimic-iii/ADMISSIONS.csv", 
                      col_types = cols(ROW_ID = col_integer(),
                                       SUBJECT_ID = col_integer(),
                                       HADM_ID = col_integer(),
                                       HOSPITAL_EXPIRE_FLAG = col_logical(),
                                       HAS_CHARTEVENTS_DATA = col_logical()))
admissions %>%
  print(width = Inf)

patients <- read_csv("/home/203bdata/mimic-iii/PATIENTS.csv")
patients %>% 
  print(width = Inf)
```

```{r}
combine <- inner_join(admissions, patients, by = "SUBJECT_ID")
combine %>% print(width = Inf)
```

### Gender

```{r}
combine %>%
  distinct(SUBJECT_ID, .keep_all = TRUE) %>%
  ggplot() +
  geom_bar(mapping = aes(x = GENDER)) +
  ggtitle("Count of admissions by gender") +
  xlab("Gender") +
  ylab("Count")
```

### Age at admission

```{r}
# combine %>%
#   group_by(SUBJECT_ID, ADMITTIME, DOB) %>%
#   summarise(n = n_distinct(SUBJECT_ID),
#             adm_age = ((ADMITTIME - DOB) / 31557600))
```

```{r}
combine %>%
  distinct(SUBJECT_ID, .keep_all = TRUE) %>%
  mutate(adm_age = (as.numeric(ADMITTIME - DOB) / 31557600)) %>%
  ggplot() +
  geom_histogram(mapping = aes(x = adm_age))
```

-----

## Q3

`ICUSTAYS.csv` (<https://mimic.physionet.org/mimictables/icustays/>) contains data about Intensive Care Units (ICU) stays. Summarize following variables using appropriate graphs:  

- length of ICU stay  
- first ICU unit  
- gender  
- age  

```{r}
icustays <- read_csv("/home/203bdata/mimic-iii/ICUSTAYS.csv")
icustays %>% print(width = Inf) 

combine2 <- inner_join(combine, icustays, by = "SUBJECT_ID")
combine2 %>% print(width = Inf)
```

### Length of ICU stay

```{r}
icustays %>%
  ggplot() + 
  geom_histogram(mapping = aes(x = LOS)) + 
  labs(title = "Count and length of stay", 
       x = "Length of stay (days)", 
       y = "Count")
```

### First ICU unit

```{r}
icustays %>% 
  distinct(SUBJECT_ID, .keep_all = TRUE) %>%
  ggplot() +
  geom_bar(mapping = aes(x = FIRST_CAREUNIT)) +
  labs(title = "Count of first ICU unit", 
       x = "First ICU unit", 
       y = "Count")
```

### Gender



### Age

```{r}
icustays %>%
  arrange(SUBJECT_ID, INTIME) %>%
  distinct(SUBJECT_ID, .keep_all = TRUE) %>%
  left_join(patients, by = "SUBJECT_ID") %>%
  mutate(age = (as.numeric(INTIME - DOB) / 525600)) %>%
  ggplot() +
  geom_histogram(mapping = aes(x = age))
```


icu intime - dob (need to link two things together)

-----

## Q4 

`CHARTEVENTS.csv` (<https://mimic.physionet.org/mimictables/chartevents/>) contains all the charted data available for a patient. During their ICU stay, the primary repository of a patientâ€™s information is their electronic chart. The `ITEMID` variable indicates a single measurement type in the database. The `VALUE` variable is the value measured for `ITEMID`. 

`D_ITEMS.csv` (<https://mimic.physionet.org/mimictables/d_items/>) is the dictionary for the `ITEMID` in `CHARTEVENTS.csv`. Find potential values of `ITEMID` that correspond to systolic blood pressure, i.e., `LABEL` contains the string `systolic`. 

Compile a tibble that contains the first ICU stay of unique patients, with the patient's demographic information, the first systolic blood pressure measurement during ICU stay, and whether the patient died within 30 days of hospital admission.

```{bash}
head /home/203bdata/mimic-iii/CHARTEVENTS.csv
echo
head /home/203bdata/mimic-iii/D_ITEMS.csv
```


```{r}
chartevents <- read_csv("/home/203bdata/mimic-iii/CHARTEVENTS.csv") %>% 
  print(width = Inf)

d_items <- read_csv("/home/203bdata/mimic-iii/D_ITEMS.csv") %>%
  print(width = Inf)
```

```{r}
systolic <- d_items %>%
  filter(grepl("systolic", LABEL)) %>% 
  print(width = Inf)
```
There are five items in the `LABEL` variable that measure systolic pressure. 

```{r}
sys_chartevents <- chartevents %>%
  filter(ITEMID %in% systolic$ITEMID) %>%
  arrange(SUBJECT_ID, CHARTTIME) %>%
  print(width = Inf)
```

This step subsetted `chartevents` to only include rows that measured systolic pressure. 

```{r}
icustays %>%
  print(width = Inf)

icustays %>%
  arrange(SUBJECT_ID, ICUSTAY_ID, INTIME) %>%
  distinct(ICUSTAY_ID, .keep_all = TRUE)
```

I wanted to check whether the `icustays` dataset had unique ICU visits, which it does since both datasets contain the same number of rows.

```{r}
icustays %>%
  # Finds unique ICU stays and selects the earliest one
  arrange(SUBJECT_ID, ICUSTAY_ID, INTIME) %>%
  distinct(ICUSTAY_ID, .keep_all = TRUE) %>%
  right_join(sys_chartevents, by = "ICUSTAY_ID") %>%
  # Sort by SUBJECT_ID and then CHARTTIME
  arrange(SUBJECT_ID.x, CHARTTIME) %>%
  # Selects the first ICU stay
  distinct(ICUSTAY_ID, .keep_all =  TRUE) %>%
  print(width = Inf)
```

I right-joined `icustays` with `sys_chartevents` (the subsetted chartevents dataset that only contained rows with a systolic pressure reading). I arranged by `SUBJECT_ID.x` and `CHARTTIME` to make sure the first systolic pressure reading was first and then selected only the first reading.

As a result, there are 808 unique ICU stays. Some patients may have multiple unique ICU stays. For example, `SUBJECT_ID` 109 has 27 unique ICU stays. 